import time
import pyotp
from SmartApi import SmartConnect

# --- CREDENTIALS (Aapne jo provide kiye) ---
API_KEY = "9SGXH14t"
CLIENT_ID = "C51790644"
PWD = "8486"
TOTP_SECRET = "KFFKBVAG7DW3UD5G7R3NWR7ZSY"

# --- STRATEGY SETTINGS ---
SYMBOL_NAME = "NIFTY"
LOT_SIZE = 25        # Nifty current lot size
RISK_REWARD = 2      # 1:2 Target
STOP_LOSS_PTS = 20   # 20 points ka SL
TARGET_PTS = 40      # 40 points ka Target

# 1. Login Process
obj = SmartConnect(api_key=API_KEY)
token = pyotp.TOTP(TOTP_SECRET).now()
session = obj.generateSession(CLIENT_ID, PWD, token)

if session['status']:
    print("‚úÖ Login Successful!")
else:
    print("‚ùå Login Failed. Check credentials.")
    exit()

def get_atm_strike(index_price):
    """Nifty ke liye 50 ke multiple mein ATM strike nikalna"""
    return round(index_price / 50) * 50

def place_trade(strike, side):
    """Live Market mein Order Place karne ka function"""
    # Note: Trading Symbol format index aur expiry ke hisaab se hota hai
    # Example: NIFTY20MAR2422100CE
    trading_symbol = f"{SYMBOL_NAME}27MAR26{strike}{side}" 
    
    print(f"üöÄ Signal Found! Placing {side} Order for {trading_symbol}")
    
    order_params = {
        "variety": "NORMAL",
        "tradingsymbol": trading_symbol,
        "symboltoken": "TOKEN_FROM_MASTER_DATA", # Token list se lena hoga
        "transactiontype": "BUY",
        "exchange": "NFO",
        "ordertype": "MARKET",
        "producttype": "INTRADAY",
        "duration": "DAY",
        "quantity": LOT_SIZE
    }
    # order_id = obj.placeOrder(order_params)
    # print(f"Order Placed ID: {order_id}")

# --- MAIN LOOP (Live Market) ---
print("Running Strategy: Bottom Fishing...")

while True:
    try:
        # 1. Live Price Fetch Karein (LTP)
        # Dummy price for logic (Real API se 'obj.ltp' use karein)
        ltp_data = obj.ltp("NSE", "Nifty 50", "99926000") # Index token
        current_price = ltp_data['data']['lasttradedprice']
        
        # 2. Strategy Logic: Bottom Kaise Pakde?
        # Logic: Agar RSI 30 ke niche hai (Oversold) aur green candle banti hai
        rsi_value = 25 # Yeh aapko indicator library (ta-lib) se nikalna hoga
        
        if rsi_value < 30: # BOTTOM SIGNAL
            atm_strike = get_atm_strike(current_price)
            place_trade(atm_strike, "CE")
            break # Ek baar trade hone par loop stop (Discipline)
            
        time.sleep(1) # API rate limit ke liye
        
    except Exception as e:
        print(f"Error occurred: {e}")
        break
            
